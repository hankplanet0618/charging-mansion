<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宜蘭礁溪充電莊 - 頂級露營體驗</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --forest-green: #15803d; --sunny-yellow: #eab308; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .zone-card { transition: all 0.3s ease; border: 1px solid #e5e7eb; }
        .zone-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: var(--forest-green); }
        .selected { border: 2px solid var(--forest-green); background-color: #f0fdf4; transform: scale(1.02); }
        .sold-out { opacity: 0.6; pointer-events: none; filter: grayscale(100%); background-color: #f3f4f6; border-color: #d1d5db; }
        .sold-out:hover { transform: none; box-shadow: none; }
        /* 數量按鈕樣式 */
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #f3f4f6; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .qty-btn:hover { background: #e5e7eb; color: var(--forest-green); }
        
        .cursor-change-image { cursor: pointer; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .filter-btn.active { background-color: var(--forest-green); color: white; }
        .rating-star { color: #d1d5db; cursor: pointer; font-size: 1.5rem; transition: color 0.2s; }
        .rating-star.active { color: #fbbf24; }
        .rating-star:hover { color: #f59e0b; }

        /* 部落格樣式 */
        .blog-scroll { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
        .blog-scroll::-webkit-scrollbar { width: 6px; }
        .blog-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .blog-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>
</head>
<body class="bg-green-50 text-stone-800 font-sans">

    <div id="overlay" onclick="closeAll()" class="fixed inset-0 bg-black bg-opacity-60 z-40 hidden transition-opacity duration-300"></div>

    <nav class="fixed w-full z-30 transition-all duration-300 bg-stone-900/95 text-white backdrop-blur-md shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="text-white hover:text-yellow-400 text-xl focus:outline-none"><i class="fas fa-bars"></i></button>
                <h1 class="text-xl font-bold tracking-wider flex items-center">
                    <i class="fas fa-bolt text-yellow-400 mr-2"></i> 充電莊
                </h1>
            </div>
            <button onclick="adminLogin()" class="text-xs border border-yellow-500 text-yellow-400 px-3 py-1 rounded hover:bg-yellow-500 hover:text-black transition focus:outline-none">
                營主後台
            </button>
        </div>
    </nav>

    <div id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <div class="h-48 bg-stone-800 flex flex-col justify-end p-6 text-white relative overflow-hidden">
            <i class="fas fa-mountain text-8xl absolute -right-4 -bottom-8 text-stone-700 opacity-50"></i>
            <h2 class="text-2xl font-bold relative z-10">選單導覽</h2>
            <p class="text-sm text-gray-400 relative z-10">探索充電莊的更多細節</p>
        </div>
        <div class="flex-1 overflow-y-auto py-2">
            <a href="#" onclick="showModal('modal-reviews')" class="flex items-center px-6 py-4 bg-orange-100 text-stone-800 font-bold border-b border-orange-200"><i class="fas fa-quote-left w-8 text-orange-600"></i> 住客回饋(評論)</a>
            <a href="#" onclick="showModal('modal-feedback')" class="flex items-center px-6 py-4 hover:bg-yellow-50 text-stone-600 border-b border-gray-100"><i class="fas fa-pen-nib w-8 text-yellow-600"></i> 住客評價</a>
            <a href="#" onclick="showModal('modal-report')" class="flex items-center px-6 py-4 hover:bg-yellow-50 text-stone-600 border-b border-gray-100"><i class="fas fa-file-invoice-dollar w-8 text-yellow-600"></i> 匯款回報</a>
            <a href="#" onclick="showModal('modal-map')" class="flex items-center px-6 py-4 hover:bg-green-50 text-stone-600 border-b border-gray-100"><i class="fas fa-map w-8 text-green-700"></i> 營位地圖</a>
            <a href="#" onclick="showModal('modal-about')" class="flex items-center px-6 py-4 hover:bg-green-50 text-stone-600 border-b border-gray-100"><i class="fas fa-seedling w-8 text-green-600"></i> 關於充電莊</a>
            <a href="#" onclick="showModal('modal-rules')" class="flex items-center px-6 py-4 hover:bg-green-50 text-stone-600 border-b border-gray-100"><i class="fas fa-clipboard-check w-8 text-red-600"></i> 營區須知</a>
            <a href="#" onclick="showModal('modal-bank')" class="flex items-center px-6 py-4 hover:bg-green-50 text-stone-600 border-b border-gray-100"><i class="fas fa-university w-8 text-blue-600"></i> 匯款資訊</a>
            <a href="#" onclick="showModal('modal-bbq')" class="flex items-center px-6 py-4 hover:bg-green-50 text-stone-600 border-b border-gray-100"><i class="fas fa-fire w-8 text-orange-600"></i> 烤肉預定</a>
            <a href="#" onclick="showModal('modal-gear')" class="flex items-center px-6 py-4 hover:bg-green-50 text-stone-600 border-b border-gray-100"><i class="fas fa-toolbox w-8 text-blue-600"></i> 裝備出租</a>
            <a href="#" onclick="showModal('modal-tent')" class="flex items-center px-6 py-4 hover:bg-green-50 text-stone-600 border-b border-gray-100"><i class="fas fa-campground w-8 text-purple-600"></i> 免搭帳服務</a>
        </div>
    </div>

    <header class="bg-stone-900 pt-20 pb-8 px-0 flex justify-center items-center">
        <div class="relative w-full max-w-7xl mx-auto px-4">
            <div class="relative aspect-video w-full overflow-hidden rounded-2xl shadow-2xl p-2 bg-gradient-to-br from-yellow-400 via-orange-500 to-red-600">
                <div class="w-full h-full overflow-hidden rounded-xl relative bg-stone-100">
                    <img src="https://i.ibb.co/6cx1xrVR/image.jpg" alt="山景" class="w-full h-full object-cover mx-auto opacity-100 hover:scale-105 transition duration-1000">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center p-4 bg-black/40">
                        <h2 class="text-3xl md:text-5xl font-bold mb-2 text-white text-shadow-lg tracking-tight">露營，是心靈充電的最佳選擇</h2>
                        <p class="text-yellow-400 font-bold tracking-widest text-sm md:text-lg">宜蘭礁溪秘境 ｜ 電動車露營首選｜ 訂位輸入電話號碼自動累積會員點數</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 pb-12 -mt-6 relative z-10" id="booking-section">
        
        <div class="grid grid-cols-3 gap-2 md:gap-4 mb-8 fade-in">
            <div onclick="showModal('modal-about')" class="bg-white p-4 rounded-xl shadow-md text-center cursor-pointer hover:bg-green-50 transition border-b-4 border-green-600">
                <i class="fas fa-seedling text-2xl text-green-600 mb-2"></i>
                <div class="text-xs md:text-sm font-bold text-gray-700">關於我們</div>
            </div>
            <div onclick="showModal('modal-rules')" class="bg-white p-4 rounded-xl shadow-md text-center cursor-pointer hover:bg-red-50 transition border-b-4 border-red-500">
                <i class="fas fa-clipboard-check text-2xl text-red-500 mb-2"></i>
                <div class="text-xs md:text-sm font-bold text-gray-700">營區須知</div>
            </div>
            <div onclick="showModal('modal-bank')" class="bg-white p-4 rounded-xl shadow-md text-center cursor-pointer hover:bg-yellow-50 transition border-b-4 border-yellow-500">
                <i class="fas fa-university text-2xl text-yellow-500 mb-2"></i>
                <div class="text-xs md:text-sm font-bold text-gray-700">匯款資訊</div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8 fade-in relative group border border-gray-100">
            <div class="bg-stone-800 p-4 flex justify-between items-center relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-stone-800 to-stone-700"></div>
                <h3 class="text-white font-bold text-lg relative z-10 flex items-center">
                    <i class="fas fa-bullhorn text-yellow-400 mr-3 animate-pulse"></i> 營主的分享
                </h3>
                <button onclick="openPostModal()" class="text-stone-500 hover:text-white transition relative z-10 p-2 rounded-full hover:bg-white/10" title="營主發文">
                    <i class="fas fa-pen-square text-xl"></i>
                </button>
            </div>
            
            <div id="blog-container" class="blog-scroll h-96 overflow-y-auto bg-stone-50 p-4 space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center mb-3">
                        <img src="https://i.ibb.co/6cx1xrVR/image.jpg" class="w-10 h-10 rounded-full object-cover border-2 border-yellow-400 mr-3">
                        <div>
                            <div class="font-bold text-stone-800 text-sm">營主 Hank <i class="fas fa-check-circle text-blue-500 ml-1"></i></div>
                            <div class="text-xs text-gray-400">剛剛 • 宜蘭礁溪</div>
                        </div>
                    </div>
                    <p class="text-gray-700 text-sm leading-relaxed mb-3">
                        歡迎來到充電莊！這裡是為電動車與露營愛好者打造的充電秘境。
                        2026年的特殊車聚日已經開放預訂囉，期待在山上見到大家！⚡️🏕️
                    </p>
                    <div class="rounded-xl overflow-hidden shadow-sm">
                        <img src="https://i.ibb.co/6cx1xrVR/image.jpg" class="w-full h-48 object-cover hover:scale-105 transition duration-700">
                    </div>
                    <div class="flex gap-4 mt-3 text-gray-400 text-xs font-bold">
                        <span><i class="fas fa-heart text-red-400 mr-1"></i> 520</span>
                        <span><i class="fas fa-comment-dots text-blue-400 mr-1"></i> 66</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-8 fade-in" style="animation-delay: 0.1s;">
            <div class="bg-[#06C755] rounded-2xl shadow-lg p-6 text-white flex flex-col md:flex-row items-center justify-between gap-4 relative overflow-hidden">
                <i class="fab fa-line absolute -right-6 -bottom-6 text-8xl opacity-10 rotate-12"></i>
                <div class="flex items-center gap-4 z-10">
                    <div class="bg-white p-3 rounded-full text-[#06C755] shadow-sm animate-bounce">
                        <i class="fab fa-line text-3xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg md:text-xl font-bold">加入 LINE@ 好友，領取優惠！記得回來用優惠券名稱結帳唷!</h3>
                        <p class="text-green-50 text-sm">輸入代碼 <span class="font-bold text-yellow-200"></span> 或優惠券名稱，立即折抵 $100</p>
                    </div>
                </div>
                <a href="https://lin.ee/t1Ds7Hq" target="_blank" class="z-10 bg-white text-[#06C755] px-6 py-2 rounded-full font-bold hover:bg-yellow-50 transition shadow-md text-sm border border-transparent hover:border-[#06C755]">
                    <i class="fas fa-gift mr-1"></i> 立即領取
                </a>
            </div>
        </div>
        
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden fade-in" style="animation-delay: 0.2s;">
            <div class="bg-green-700 p-4 text-white text-center">
                <h3 class="font-bold text-lg">線上預訂單</h3>
            </div>

            <form id="bookingForm" class="p-6 space-y-8">
                <input type="hidden" name="sheetName" value="訂單資料">
                
                <div>
                    <h4 class="text-lg font-bold text-stone-800 mb-4 border-l-4 border-green-600 pl-3">基本資料</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">訂位大名</label>
                            <input type="text" name="訂位大名" required class="w-full bg-stone-50 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">聯絡電話</label>
                            <input type="tel" name="聯絡電話" required class="w-full bg-stone-50 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Line ID</label>
                            <input type="text" name="Line ID" required class="w-full bg-stone-50 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="方便我們聯繫您">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Email (接收訂位通知)</label>
                            <input type="email" name="Email" required class="w-full bg-stone-50 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="請輸入 Email">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">入住日期 <span class="text-red-500 text-xs">(2026/2/1 後開放)</span></label>
                            <input type="date" id="checkinDate" name="入住日期" required min="2026-02-01" class="w-full bg-stone-50 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">退房日期</label>
                            <div class="flex items-center gap-2">
                                <input type="date" id="checkoutDate" name="退房日期" required min="2026-02-02" class="w-full bg-stone-50 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none">
                                <span id="stayDays" class="text-sm font-bold text-green-600 whitespace-nowrap hidden"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-200">

                <div>
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-stone-800 border-l-4 border-green-600 pl-3 mb-2 md:mb-0">選擇營位 (可複選)</h4>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar w-full md:w-auto p-1 bg-stone-100 rounded-lg">
                            <button type="button" onclick="filterZones('all')" class="filter-btn active px-3 py-1 rounded-md text-xs font-bold transition-all text-gray-500 whitespace-nowrap">全部</button>
                            <button type="button" onclick="filterZones('shelter')" class="filter-btn px-3 py-1 rounded-md text-xs font-bold transition-all text-gray-500 whitespace-nowrap">雨棚區</button>
                            <button type="button" onclick="filterZones('room')" class="filter-btn px-3 py-1 rounded-md text-xs font-bold transition-all text-gray-500 whitespace-nowrap">住宿/懶人</button>
                            <button type="button" onclick="filterZones('grass')" class="filter-btn px-3 py-1 rounded-md text-xs font-bold transition-all text-gray-500 whitespace-nowrap">草地/碎石</button>
                        </div>
                    </div>
                    
                    <input type="hidden" name="預訂區域" id="zoneStringOutput">
                    <input type="hidden" id="selectedZoneRemaining" value="99"> 
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="zoneContainer">
                        </div>

                    <div class="mt-6">
                        <label class="block text-xs font-bold text-gray-500 mb-1">預訂數量 (帳/間)</label>
                        <select name="預訂數量" id="quantitySelect" class="w-full md:w-1/3 bg-stone-50 border border-gray-300 rounded-lg p-3 outline-none">
                            <option value="1">1</option>
                        </select>
                    </div>
                </div>

                <hr class="border-gray-200">

                <div class="bg-orange-50 border border-orange-200 rounded-xl p-4">
                    <div class="flex flex-col md:flex-row items-center gap-4">
                        <div class="w-full md:w-auto flex-shrink-0">
                            <img src="https://i.ibb.co/N623cTjr/1299.png" alt="3人份烤肉套餐" class="w-full h-auto">
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-orange-800 text-lg flex items-center">
                                <i class="fas fa-fire mr-2"></i> 加購：3人份烤肉套餐 ($1299)
                            </h4>
                            <p class="text-xs text-orange-600 mt-1">食材豐富，懶人露營首選！費用將合併計算。</p>
                        </div>
                        <div class="w-full md:w-auto">
                            <label class="block text-xs font-bold text-orange-800 mb-1">選擇份數</label>
                            <select name="加購烤肉" id="bbqSelect" class="w-full bg-white border border-orange-300 rounded-lg p-2 outline-none text-orange-900 font-bold">
                                <option value="0">不需要</option>
                                <option value="1">1 份 (+$1299)</option>
                                <option value="2">2 份 (+$2598)</option>
                                <option value="3">3 份 (+$3897)</option>
                                <option value="4">4 份 (+$5196)</option>
                                <option value="5">5 份 (+$6495)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-200">

                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <label class="block text-xs font-bold text-green-800 mb-1"><i class="fas fa-tags mr-1"></i> 優惠折扣碼 (LINE好友專屬)</label>
                    <div class="flex gap-2">
                        <input type="text" id="discountCodeInput" name="折扣碼" placeholder="請輸入代碼或券名" class="flex-1 bg-white border border-green-300 rounded-lg p-2 outline-none focus:ring-2 focus:ring-green-500">
                        <button type="button" onclick="applyDiscount()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-500 transition">套用</button>
                    </div>
                    <p id="discountMsg" class="text-xs mt-2 text-gray-500 h-4"></p>
                    <input type="hidden" name="折扣金額" id="discountValue" value="0">
                </div>

                <hr class="border-gray-200">

                <div>
                    <h4 class="text-lg font-bold text-stone-800 mb-4 border-l-4 border-green-600 pl-3">特殊需求</h4>
                    <textarea name="備註需求" placeholder="例如：我是特斯拉車主需要充電 (請提供車號)、需要租借裝備、烤肉用餐時間..." class="w-full bg-stone-50 border border-gray-300 rounded-lg p-3 h-24 focus:ring-2 focus:ring-green-500 outline-none resize-none"></textarea>
                </div>

                <div id="priceCalcResult" class="hidden bg-yellow-50 border border-yellow-200 p-4 rounded-xl">
                    <div id="validPriceResult">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm text-gray-600">小計</span>
                            <span class="text-sm font-bold text-gray-800" id="subtotalDisplay">$0</span>
                        </div>
                        <div class="flex justify-between items-center mb-2" id="discountRow" style="display:none;">
                            <span class="text-sm text-green-600">折扣</span>
                            <span class="text-sm font-bold text-green-600" id="discountDisplay">-$0</span>
                        </div>
                        <hr class="border-yellow-200 mb-2">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="block text-gray-600 font-bold text-sm">預估總金額</span>
                                <span class="text-xs text-gray-500" id="priceFormula"></span>
                            </div>
                            <div class="text-2xl font-extrabold text-red-600" id="totalPriceDisplay">$0</div>
                        </div>
                    </div>
                    <div id="blockedDateMsg" class="hidden text-center"></div>
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-stone-800 text-white font-bold py-4 rounded-xl text-lg shadow-lg hover:bg-stone-700 transition transform hover:scale-[1.01] active:scale-95">
                    確認送出預訂
                </button>
                <p class="text-center text-xs text-gray-400 mt-2">點擊送出即代表同意營區須知</p>

            </form>
        </div>
    </main>

    <footer class="bg-stone-900 text-stone-400 py-8 text-center text-sm">
        <p class="mb-2 text-white font-bold text-lg"><i class="fas fa-bolt text-yellow-400 mr-2"></i> 宜蘭礁溪充電莊</p>
        <p class="mb-4">宜蘭縣礁溪鄉匏杓崙路150之8號</p>
        <div class="flex justify-center gap-4 mb-4">
            <a href="#" class="w-8 h-8 rounded-full bg-stone-700 flex items-center justify-center hover:bg-blue-600 hover:text-white transition"><i class="fab fa-facebook-f"></i></a>
            <a href="https://lin.ee/t1Ds7Hq" target="_blank" class="w-8 h-8 rounded-full bg-stone-700 flex items-center justify-center hover:bg-[#06C755] hover:text-white transition"><i class="fab fa-line"></i></a>
            <a href="#" class="w-8 h-8 rounded-full bg-stone-700 flex items-center justify-center hover:bg-red-500 hover:text-white transition"><i class="fas fa-map-marker-alt"></i></a>
        </div>
        <p>© 2025 Charging Manor.</p>
    </footer>

    <div id="modal-post" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div>
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl z-10 p-6 relative">
            <button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold mb-4 text-stone-800 text-center"><i class="fas fa-pen-fancy mr-2"></i> 發布新動態</h3>
            <form id="postForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">貼文內容 (必填)</label>
                    <textarea name="postContent" id="postContent" rows="4" class="w-full border rounded-lg p-3 bg-gray-50 focus:bg-white transition" placeholder="分享今天營區發生什麼趣事吧..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">圖片網址 (選填)</label>
                    <input type="text" name="postImage" id="postImage" class="w-full border rounded-lg p-2" placeholder="https://...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Youtube 影片網址 (選填)</label>
                    <input type="text" name="postVideo" id="postVideo" class="w-full border rounded-lg p-2" placeholder="https://youtube.com/...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">打卡地點 (選填)</label>
                    <input type="text" name="postLocation" id="postLocation" class="w-full border rounded-lg p-2" value="宜蘭礁溪充電莊" placeholder="例如：充電莊 A 區">
                </div>
                <button type="button" onclick="submitPost()" class="w-full bg-stone-800 text-white font-bold py-3 rounded-lg hover:bg-stone-700 transition">立即發布</button>
            </form>
        </div>
    </div>

    <div id="modal-reviews" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div>
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl z-10 p-6 relative max-h-[80vh] overflow-y-auto">
            <button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold mb-6 text-orange-700 text-center flex items-center justify-center">
                <i class="fas fa-quote-left mr-2"></i> 住客回饋(評論)
            </h3>
            
            <div class="space-y-4">
                <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-orange-200 rounded-full flex items-center justify-center text-orange-700 font-bold mr-2">陳</div>
                            <div>
                                <div class="text-sm font-bold text-gray-800">陳小姐</div>
                                <div class="text-xs text-gray-500">入住日期: 2025/01/15</div>
                            </div>
                        </div>
                        <div class="text-yellow-400 text-sm">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700">環境非常棒，充電很方便！而且雨棚區真的很大，下雨天露營也完全不用擔心，小孩玩得很開心。</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-200 rounded-full flex items-center justify-center text-green-700 font-bold mr-2">林</div>
                            <div>
                                <div class="text-sm font-bold text-gray-800">林先生 (Tesla Model Y)</div>
                                <div class="text-xs text-gray-500">入住日期: 2025/02/03</div>
                            </div>
                        </div>
                        <div class="text-yellow-400 text-sm">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700">為了充電樁來的，真的沒讓人失望！可以直接在營位旁邊充電超級方便，隔天滿電出發，老闆人也很熱情。</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-200 rounded-full flex items-center justify-center text-blue-700 font-bold mr-2">W</div>
                            <div>
                                <div class="text-sm font-bold text-gray-800">Wu Jason</div>
                                <div class="text-xs text-gray-500">入住日期: 2025/01/20</div>
                            </div>
                        </div>
                        <div class="text-yellow-400 text-sm">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700">烤肉套餐份量很足，食材也很新鮮。小木屋很乾淨，雖然不大但很溫馨，適合懶人露營。</p>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400">以上顯示部分精選好評</p>
                <button onclick="closeAll(); showModal('modal-feedback')" class="mt-4 text-sm text-orange-600 font-bold hover:underline">我也要填寫評價 <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <div id="modal-feedback" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div>
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl z-10 p-6 relative">
            <button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold mb-4 text-yellow-700 text-center">住客評價</h3>
            <div id="feedback-form-container">
                <form id="feedbackForm" class="space-y-4">
                    <input type="hidden" name="sheetName" value="住客回饋">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">入住日期</label><input type="date" name="入住日期" required class="w-full border rounded p-2"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">住客姓名</label><input type="text" name="住客姓名" required class="w-full border rounded p-2" placeholder="請輸入訂位大名"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">滿意度</label>
                        <div class="flex gap-2 text-2xl text-gray-300" id="star-container"><i class="fas fa-star rating-star" data-val="1"></i><i class="fas fa-star rating-star" data-val="2"></i><i class="fas fa-star rating-star" data-val="3"></i><i class="fas fa-star rating-star" data-val="4"></i><i class="fas fa-star rating-star" data-val="5"></i></div>
                        <input type="hidden" name="滿意度" id="ratingInput" value="">
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">想對我們說的話 (回饋)</label><textarea name="回饋內容" rows="3" class="w-full border rounded p-2" placeholder="歡迎分享您的體驗心得..."></textarea></div>
                    <button type="submit" id="feedbackBtn" class="w-full bg-yellow-600 text-white font-bold py-3 rounded-lg hover:bg-yellow-500 transition">送出回饋</button>
                </form>
            </div>
            <div id="feedback-success" class="hidden text-center py-6">
                <div class="mb-4 text-green-500 text-5xl animate-bounce"><i class="fas fa-check-circle"></i></div>
                <h4 class="text-2xl font-bold text-gray-800 mb-2">感謝您的回饋！</h4>
                <div class="bg-yellow-50 border-2 border-dashed border-yellow-400 p-4 rounded-xl inline-block w-full"><p class="text-sm text-yellow-800 font-bold mb-1">下次訂位專屬優惠碼</p><div class="text-3xl font-mono font-bold text-yellow-600 tracking-wider">CM100</div><p class="text-xs text-yellow-600 mt-1">立折 $100 元</p></div>
            </div>
        </div>
    </div>

    <div id="modal-map" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div>
        <div class="bg-white w-full max-w-6xl rounded-2xl shadow-xl z-10 relative overflow-hidden flex flex-col h-[90vh]">
            <button onclick="closeAll()" class="absolute top-4 right-4 text-gray-600 bg-white/90 rounded-full w-10 h-10 flex items-center justify-center hover:bg-white hover:text-black z-20 shadow-lg font-bold text-xl transition"><i class="fas fa-times"></i></button>
            <div class="flex-1 w-full h-full bg-gray-100 overflow-auto p-4 flex flex-col items-center">
                <img src="https://i.ibb.co/DHK9NKfP/image.png" alt="營位地圖" class="w-full h-auto object-contain shadow-md mb-6">
                <a href="充電莊地圖.pdf" target="_blank" class="bg-green-600 text-white px-6 py-3 rounded-full font-bold hover:bg-green-700 transition shadow-lg flex items-center text-lg">
                    <i class="fas fa-file-pdf mr-2"></i> 下載高清 PDF 地圖
                </a>
                <p class="text-gray-500 text-sm mt-2">如需放大檢視細節，建議下載 PDF</p>
            </div>
        </div>
    </div>

    <div id="modal-report" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div><div class="bg-white w-full max-w-md rounded-2xl shadow-xl z-10 p-6 relative"><button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button><h3 class="text-xl font-bold mb-4 text-center text-yellow-600">匯款回報</h3><form id="paymentForm" class="space-y-4"><input type="hidden" name="sheetName" value="匯款紀錄"><div><label class="block text-xs font-bold text-gray-500 mb-1">匯款姓名</label><input type="text" name="匯款姓名" required class="w-full border rounded p-2"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">帳號末五碼</label><input type="text" name="末五碼" required class="w-full border rounded p-2"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">匯款金額</label><input type="number" name="匯款金額" required class="w-full border rounded p-2"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">匯款日期</label><input type="date" name="匯款日期" required class="w-full border rounded p-2"></div><button type="submit" id="payBtn" class="w-full bg-yellow-500 text-stone-900 font-bold py-3 rounded-lg hover:bg-yellow-400">送出回報</button></form></div></div>
    <div id="modal-bank" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div><div class="bg-white w-full max-w-md rounded-2xl shadow-xl z-10 p-6 relative"><button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button><h3 class="text-xl font-bold mb-4 text-center">匯款資訊</h3><div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200"><p class="text-sm text-gray-600">銀行：<span class="font-bold text-black">823 將來銀行</span></p><p class="text-sm text-gray-600 mt-2">戶名：<span class="font-bold text-black">林均鴻</span></p><p class="text-sm text-gray-600 mt-2">帳號：</p><p class="text-xl font-mono font-bold text-blue-800 bg-white p-2 rounded border mt-1 text-center">8865-0975-0204-25</p></div><p class="text-xs text-center text-gray-400 mt-4">匯款後請點選選單「匯款回報」</p></div></div>
    
    <div id="modal-about" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div>
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl z-10 p-6 relative max-h-[80vh] overflow-y-auto">
            <button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold mb-4 text-green-700">關於充電莊</h3>
            <div class="prose prose-stone text-sm text-gray-700 leading-relaxed">
                <div class="mb-6 text-center border-b pb-4">
                    <p class="text-gray-500 italic mb-2">隱在宜蘭礁溪深溝的山腰，像一首還未被唱起的祕密詩。</p>
                    <p>這裡沒有繁複造景，卻能遠眺四季<span class="text-yellow-600 font-bold">龜山島</span>的日出日落；<br>
                    感受秋日<span class="text-yellow-600 font-bold">落羽松</span>鋪出的一地紅毯；<br>
                    聆聽夏日蟲鳴、潮聲。</p>
                </div>
                <div class="mb-6 bg-stone-50 p-4 border-l-4 border-green-700 rounded">
                    <p class="mb-2">這裡有 <strong>95% 雨棚營位</strong>，讓喜愛露營的人下雨不淋、烈日不曬；懶人能躺平，孩子能放電。</p>
                    <p>在這裡插上<span class="text-yellow-600 font-bold">充電槍</span>，泡一壺茶，坐進彩色木椅，看電量悠悠回滿；<br>
                    看光線擁吻山海；看孩子追螢火蟲，追著夏日的童年。</p>
                </div>
                <div class="mb-6 relative p-4 bg-green-50 rounded-lg italic">
                    <span class="absolute top-0 left-2 text-6xl text-green-200 opacity-50 font-serif">“</span>
                    <p>2025 年，我露營了七十七次。</p>
                    <p>我知道露營的幸福，是有風有雨也不狼狽，有星有月也不孤單。</p>
                    <p>於是我接下了「<strong>充電莊</strong>」——這裡不是我的營地，是我兒子的王國，也是為每一個電量歸零的人，準備的一個溫暖避風港。</p>
                </div>
                <div class="mb-6 text-justify">
                    <p>如果有一天，你開上山路，電量亮紅，請再往前一點點。</p>
                    <p>你會看見落羽松在搖、燈在亮，茶香飄來，孩子笑著奔跑。</p>
                    <p>那一刻，你就到了。</p>
                </div>
                <div class="mb-6 text-center font-medium">
                    <p>這裡允許你把電放完，也把心充滿；<br>
                    允許你懶，也允許你盡情奔跑。</p>
                </div>
                <div class="text-center mt-8">
                    <h3 class="text-green-800 font-bold text-lg mb-2">「山中若有眠，夢裡總是青。」</h3>
                    <p>歡迎愛露營的你，來這裡充電。</p>
                    <div class="mt-4 p-3 bg-green-50 rounded text-green-800 font-bold border-l-4 border-green-600">希望來到充電莊的你們，也能跟我一樣，找到屬於自己的那座山。</div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-rules" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div><div class="bg-white w-full max-w-lg rounded-2xl shadow-xl z-10 p-6 relative max-h-[80vh] overflow-y-auto"><button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button><h3 class="text-xl font-bold mb-4 text-red-600">營區須知</h3><ul class="list-disc pl-5 space-y-2 text-sm text-gray-700"><li>請注意寧靜時間為每天晚上10點後，請放低音量。<li>電動車車主請務必於表單備註，將優先安排充電位置（全區共 17 台）。<li>焚火請務必自備木柴、防火布及焚火爐，禁止直接在地面生火。<li>本營區不禁菸，但吸煙者請移步至接待處附近指定區域抽煙。<li>若進行溪邊活動將分組，可自行帶補蝦籠，有機會抓到溪蝦 (請注意安全)。<li>夜衝自搭帳及車泊每帳 $600；民宿、小木屋、露營車及 T 250 為 5 折優惠。夜衝時間為 17:00-22:00。<li>營區有各項設備可出租，詳細項目及金額請查看裝備表。
<li>用電設備不特定限制，每座插座規格為 15-20A。</li></ul></div></div>
    <div id="modal-bbq" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div><div class="bg-white w-full max-w-md rounded-2xl shadow-xl z-10 p-6 relative"><button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button><h3 class="text-xl font-bold mb-4 text-orange-600">烤肉預定</h3><div class="bg-orange-50 p-4 rounded border border-orange-200 text-center"><img src="https://i.ibb.co/N623cTjr/1299.png" alt="烤肉套餐" class="w-full h-48 object-cover rounded-lg mb-4"><h4 class="font-bold text-lg">基本 3 人套餐</h4><p class="text-3xl font-bold text-red-600 my-2">$1,299</p></div></div></div>
    <div id="modal-gear" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div><div class="bg-white w-full max-w-lg rounded-2xl shadow-xl z-10 p-6 relative max-h-[80vh] overflow-y-auto"><button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button><h3 class="text-xl font-bold mb-4 text-blue-600">裝備出租</h3><table class="w-full text-sm text-left"><tbody id="gearTableBody" class="divide-y"></tbody></table></div></div>
    
    <div id="modal-tent" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60" onclick="closeAll()"></div>
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-xl z-10 p-6 relative max-h-[85vh] overflow-y-auto">
            <button onclick="closeAll()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold mb-4 text-purple-600">免搭帳服務</h3>
            
            <div class="bg-purple-50 p-3 rounded text-center mb-6 border-l-4 border-purple-600">
                <span class="block font-bold text-purple-900 text-sm">代搭服務費 (不含裝備租金)</span>
                <span class="text-2xl font-bold text-purple-600">$500</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition">
                    <img src="https://i.ibb.co/sp3sd0WW/4-2.jpg" class="w-full h-56 object-contain bg-gray-50 cursor-pointer hover:opacity-90" onclick="window.open(this.src)">
                    <div class="p-3">
                        <h4 class="font-bold text-gray-800">迪卡儂 4.2 充氣帳</h4>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">2房1廳</span>
                            <span class="font-bold text-purple-600">$800</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition">
                    <img src="https://i.ibb.co/K391LwV/6.jpg" class="w-full h-56 object-contain bg-gray-50 cursor-pointer hover:opacity-90" onclick="window.open(this.src)">
                    <div class="p-3">
                        <h4 class="font-bold text-gray-800">挪客屋脊 6</h4>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">自動帳</span>
                            <span class="font-bold text-purple-600">$600</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition">
                    <img src="https://i.ibb.co/1gJZmLv/IF-6-0.jpg" class="w-full h-56 object-contain bg-gray-50 cursor-pointer hover:opacity-90" onclick="window.open(this.src)">
                    <div class="p-3">
                        <h4 class="font-bold text-gray-800">IF 充氣帳篷 6.0</h4>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">高顏值</span>
                            <span class="font-bold text-purple-600">$800</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition">
                    <img src="https://i.ibb.co/NnNrFZR2/9.jpg" class="w-full h-56 object-contain bg-gray-50 cursor-pointer hover:opacity-90" onclick="window.open(this.src)">
                    <div class="p-3">
                        <h4 class="font-bold text-gray-800">杜邦鯤9車尾帳</h4>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Model Y 99%密合</span>
                            <span class="font-bold text-purple-600">$1,000</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition md:col-span-2">
                    <img src="https://i.ibb.co/39GMJ3Bp/tw-11134208-81ztg-meterwxf57gmfa.jpg" class="w-full h-64 object-contain bg-gray-50 cursor-pointer hover:opacity-90" onclick="window.open(this.src)">
                    <div class="p-3">
                        <h4 class="font-bold text-gray-800">KZM T-250 (科技棉)</h4>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">一房一廳</span>
                            <span class="font-bold text-purple-600 text-lg">$2,000</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ★★★ 務必確認這是您最新的 Script 網址 ★★★
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwTJgjpDrgdoJezv940KBKjw9gmKFl73czqa2ZS4ig6urbuVcnFaUH_PoyA0e1tLv65/exec'; 
        const adminSheetURL = 'https://docs.google.com/spreadsheets/d/1frnxcFu6ZvYjUaSRpbq84ROjWYIY4mrHLDyjR1InyXg/edit?gid=0#gid=0';
        
        // ★★★ 全區封鎖日期 (不開放預訂) ★★★
        const closedDates = ['2026-02-07', '2026-03-07'];

        // ★★★ 2026-2031 特別價格日期區間設定 (嚴格遵照您的清單，不含其他週末) ★★★
        const specialRanges = [
            // 2026
            {s:'2026-02-14', e:'2026-02-22'}, {s:'2026-02-27', e:'2026-03-01'}, {s:'2026-04-03', e:'2026-04-06'},
            {s:'2026-05-01', e:'2026-05-03'}, {s:'2026-06-19', e:'2026-06-21'}, {s:'2026-09-25', e:'2026-09-28'},
            {s:'2026-10-09', e:'2026-10-11'}, {s:'2026-10-24', e:'2026-10-26'}, {s:'2026-12-25', e:'2026-12-27'},
            // 2027
            {s:'2027-01-01', e:'2027-01-03'}, {s:'2027-02-04', e:'2027-02-10'}, {s:'2027-02-27', e:'2027-03-01'},
            {s:'2027-04-03', e:'2027-04-06'}, {s:'2027-04-30', e:'2027-05-02'}, {s:'2027-10-09', e:'2027-10-11'},
            {s:'2027-10-23', e:'2027-10-25'}, {s:'2027-12-24', e:'2027-12-26'}, {s:'2027-06-09', e:'2027-06-09'},
            {s:'2027-09-15', e:'2027-09-15'}, {s:'2027-09-25', e:'2027-09-28'},
            // 2028
            {s:'2027-12-31', e:'2028-01-02'}, {s:'2028-01-22', e:'2028-01-30'}, {s:'2028-02-26', e:'2028-02-28'},
            {s:'2028-04-29', e:'2028-05-01'}, {s:'2028-05-27', e:'2028-05-29'}, {s:'2028-12-23', e:'2028-12-25'},
            {s:'2028-10-25', e:'2028-10-25'}, {s:'2028-04-01', e:'2028-04-04'}, {s:'2028-09-28', e:'2028-10-01'},
            {s:'2028-09-30', e:'2028-10-03'}, {s:'2028-10-07', e:'2028-10-10'},
            // 2029
            {s:'2028-12-30', e:'2029-01-01'}, {s:'2029-02-10', e:'2029-02-18'}, {s:'2029-06-15', e:'2029-06-17'},
            {s:'2029-09-21', e:'2029-09-23'}, {s:'2029-09-28', e:'2029-09-30'}, {s:'2029-02-28', e:'2029-02-28'},
            {s:'2029-04-04', e:'2029-04-04'}, {s:'2029-10-10', e:'2029-10-10'}, {s:'2029-04-28', e:'2029-05-01'},
            {s:'2029-10-25', e:'2029-10-28'}, {s:'2029-12-22', e:'2029-12-25'},
            // 2030
            {s:'2030-02-01', e:'2030-02-07'}, {s:'2030-04-04', e:'2030-04-07'}, {s:'2030-09-27', e:'2030-09-29'},
            {s:'2030-10-25', e:'2030-10-27'}, {s:'2030-05-01', e:'2030-05-01'}, {s:'2030-06-05', e:'2030-06-05'},
            {s:'2030-12-25', e:'2030-12-25'}, {s:'2029-12-29', e:'2030-01-01'}, {s:'2030-02-28', e:'2030-03-03'},
            {s:'2030-09-12', e:'2030-09-15'}, {s:'2030-10-10', e:'2030-10-13'},
            // 2031
            {s:'2031-01-18', e:'2031-01-26'}, {s:'2031-02-28', e:'2031-03-02'}, {s:'2031-04-03', e:'2031-04-06'},
            {s:'2031-09-27', e:'2031-09-29'}, {s:'2031-10-10', e:'2031-10-12'}, {s:'2031-10-24', e:'2031-10-26'},
            {s:'2031-01-01', e:'2031-01-01'}, {s:'2031-10-01', e:'2031-10-01'}, {s:'2031-05-01', e:'2031-05-04'},
            {s:'2031-06-21', e:'2031-06-24'}, {s:'2031-12-25', e:'2031-12-28'}
        ];

        // 判斷日期是否為加價/特殊日 (只比對上面的清單，不自動判斷週六日)
        function isSpecialDate(dateStr) {
            return specialRanges.some(r => dateStr >= r.s && dateStr <= r.e);
        }

        // 根據日期獲取該區域的價格
        function getDynamicPrice(zoneId, dateStr) {
            // ★★★ 先檢查是否為封鎖日 (不開放預訂) ★★★
            if (closedDates.includes(dateStr)) {
                return -1; // 全區不開放 (Blocked)
            }

            const isSpecial = isSpecialDate(dateStr);
            if (!isSpecial) {
                // 非名單內的日期，一律視為平日價格 (不管是不是週六)
                const z = zones.find(x => x.id === zoneId);
                return z ? z.price : 0;
            }
            
            // 名單內的特殊日期，使用加價價格
            switch(zoneId) {
                case 'ZC2': return 3000;  // 小木屋大
                case 'ZC3': return 2600;  // 小木屋小
                case 'ZE1': return 20000; // 包棟民宿
                case 'ZC1': return -1;    // 露營車 (封鎖)
                default: return 1500;     // 其餘營位 (原價 1200 -> 特殊日 1500)
            }
        }

        const discountCodes = {
            'LINE100': 100,
            'CM100': 100, 
            '首次加入好友': 100,
            '首次加入好友優惠券': 100,
            '首次加入好友禮': 100,
            'TESLA2026': 100,
            'Chunhunglinonly': 9999999
        }; 

        let bookedData = {}; 
        let cart = {}; 

        // ★★★ 營主分享功能 ★★★
        function openPostModal() {
            const pwd = prompt("請輸入營主密碼以發文：");
            if (pwd === "Hank0219") {
                showModal('modal-post');
            } else if (pwd !== null) {
                alert("密碼錯誤");
            }
        }

        function submitPost() {
            const content = document.getElementById('postContent').value;
            const image = document.getElementById('postImage').value;
            const video = document.getElementById('postVideo').value;
            const location = document.getElementById('postLocation').value;

            if (!content) { alert('請輸入貼文內容！'); return; }

            // 建立貼文 HTML
            const date = new Date().toLocaleDateString('zh-TW');
            const postHTML = `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 fade-in">
                    <div class="flex items-center mb-3">
                        <img src="https://i.ibb.co/6cx1xrVR/image.jpg" class="w-10 h-10 rounded-full object-cover border-2 border-yellow-400 mr-3">
                        <div>
                            <div class="font-bold text-stone-800 text-sm">營主 Hank <i class="fas fa-check-circle text-blue-500 ml-1"></i></div>
                            <div class="text-xs text-gray-400">${date} • ${location || '宜蘭礁溪充電莊'}</div>
                        </div>
                    </div>
                    <p class="text-gray-700 text-sm leading-relaxed mb-3 whitespace-pre-wrap">${content}</p>
                    ${image ? `<div class="rounded-xl overflow-hidden shadow-sm mb-3"><img src="${image}" class="w-full max-h-64 object-cover" onerror="this.style.display='none'"></div>` : ''}
                    ${video ? `<div class="rounded-xl overflow-hidden shadow-sm aspect-video mb-3"><iframe class="w-full h-full" src="${video.replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen></iframe></div>` : ''}
                    <div class="flex gap-4 mt-2 text-gray-400 text-xs font-bold">
                        <span class="hover:text-red-500 cursor-pointer transition"><i class="fas fa-heart mr-1"></i> 0</span>
                        <span class="hover:text-blue-500 cursor-pointer transition"><i class="fas fa-comment-dots mr-1"></i> 0</span>
                    </div>
                </div>
            `;

            // 插入到最上方
            const container = document.getElementById('blog-container');
            container.insertAdjacentHTML('afterbegin', postHTML);
            
            // 清空並關閉
            document.getElementById('postForm').reset();
            closeAll();
            
            // 提醒使用者後端串接
            console.log("提示：目前貼文僅暫存於前端顯示。若要永久儲存，需將資料 POST 到 Google Apps Script 並儲存於 Sheet。");
        }

        function init() { 
            console.log("正在載入即時庫存...");
            
            fetch(scriptURL)
                .then(response => response.json())
                .then(data => {
                    console.log("庫存載入成功:", data);
                    bookedData = data; 
                    
                    renderZones('all'); 
                    renderGears(); 
                    setupCalculator(); 
                    updateQuantityOptions(8);
                })
                .catch(error => {
                    console.error("庫存載入失敗:", error);
                    alert("⚠️ 無法讀取即時庫存，請稍後再試或聯繫營主。");
                    renderZones('all'); 
                });
        }

        const zones = [
            { id: 'ZA1', name: '棚架 A 區', count: 9, cat: 'shelter', desc: '寬敞遮雨棚車停帳邊 (9帳)', price: 1200, badge: '熱門', images: ['https://i.ibb.co/KjBcKGvt/A-DDcar.jpg', 'https://i.ibb.co/RTypZTzW/A1.jpg', 'https://i.ibb.co/hRNQ84SY/A.jpg'], idx: 0 },
            { id: 'ZA2', name: '棚架 B 區', count: 4, cat: 'shelter', desc: '適合包區車停帳邊 (4帳)', price: 1200, badge: '包區熱門', images: ['https://i.ibb.co/bMQ51htS/B.jpg', 'https://i.ibb.co/7JY7xRYp/B.jpg'], idx: 0 },
            { id: 'ZA3', name: '棚架 C 區', count: 3, cat: 'shelter', desc: '安靜舒適獨立區車停帳邊 (3帳)', price: 1200, badge: '清靜悠閒', images: ['https://i.ibb.co/c70KNkJ/C1.jpg', 'https://i.ibb.co/zTRCxcwq/2.jpg'], idx: 0 },
            { id: 'ZB1', name: '棧板 A 區', count: 3, cat: 'grass', desc: '架高防潮+遊戲區 (3帳)', price: 1200, badge: '', images: ['https://i.ibb.co/XrMggq46/1.jpg'], idx: 0 },
            { id: 'ZB2', name: '棧板 B 區', count: 2, cat: 'grass', desc: '棚架下的慵懶 (2帳)', price: 1200, badge: '超大空間', images: ['https://i.ibb.co/JRmcf3bw/B.jpg'], idx: 0 },
            { id: 'ZC1', name: '三人頂級露營車', count: 2, cat: 'room', desc: '最有溫度的一晚 (2台)', price: 6980, badge: '送烤肉', images: ['https://i.ibb.co/jvXBxJWw/4.jpg'], idx: 0 },
            { id: 'ZC2', name: '小木屋 (大)', count: 1, cat: 'room', desc: '家庭首選 (1間)', price: 2500, badge: '最夯首選', images: ['https://i.ibb.co/4n2CPt5X/image.jpg', 'https://i.ibb.co/VYpvt7NF/image.jpg'], idx: 0 },
            { id: 'ZC3', name: '小木屋 (小)', count: 1, cat: 'room', desc: '溫馨三人 (1間)', price: 2200, badge: '', images: ['https://i.ibb.co/CpNgsKHw/image.jpg', 'https://i.ibb.co/VW4t8GH4/image.jpg'], idx: 0 },
            { id: 'ZD1', name: '草地區', count: 6, cat: 'grass', desc: '親近自然的美好車停帳邊 (6帳)', price: 1200, badge: '自然紮營', images: ['https://i.ibb.co/7xsg5nfv/1.jpg', 'https://i.ibb.co/DDLBdhNk/3.jpg', 'https://i.ibb.co/S73TLHJR/2.jpg'], idx: 0 },
            { id: 'ZD2', name: '碎石地區', count: 2, cat: 'grass', desc: '充電紮營首選車停帳邊 (2帳)', price: 1200, badge: '碎石美好', images: ['https://i.ibb.co/k6D740Ht/image.jpg'], idx: 0 },
            { id: 'ZE1', name: '包棟民宿 (16人)', count: 1, cat: 'room', desc: '4房/多人K歌最開心 (1棟)', price: 18000, badge: '獨享群樂', images: ['https://i.ibb.co/6RyZYPVy/7-KW.jpg'], idx: 0 },
            { id: 'ZF1', name: '泰式免搭', count: 8, cat: 'room', desc: '懶人新福音 (8帳)', price: 1200, badge: '最新', images: ['https://i.ibb.co/60bXNB57/image.jpg', 'https://i.ibb.co/DHhm1sWR/2.jpg'], idx: 0 }
        ];

        const gears = [{n:'月亮椅/休閒椅',p:'100'},{n:'平躺椅',p:'150'},{n:'卡式爐/蜘蛛爐(含瓦斯)',p:'200'},{n:'五星爐(含瓦斯)',p:'300'},{n:'IGT桌全套',p:'600'},{n:'天幕 3*3+桿',p:'250'},{n:'天幕 3*5+桿',p:'350'},{n:'超聲波地墊 3*3',p:'150'},{n:'野餐地墊 2*2/燈具',p:'100'},{n:'落地頂級四葉燈',p:'350'},{n:'杜邦鯤9車尾帳',p:'1000'},{n:'代搭帳服務',p:'500'},{n:'投影機',p:'300'},{n:'投影布幕',p:'100'},{n:'電暖器/焚火台(鐵)',p:'200'},{n:'焚火台(純鈦)',p:'350'},{n:'木柴',p:'100'}];

        let currentDiscount = 0;
        let currentFilter = 'all'; 

        window.applyDiscount = () => {
            const code = document.getElementById('discountCodeInput').value.trim(); 
            const msg = document.getElementById('discountMsg');
            const discountRow = document.getElementById('discountRow');
            const discountDisplay = document.getElementById('discountDisplay');
            const discountInput = document.getElementById('discountValue');

            if (discountCodes.hasOwnProperty(code)) {
                currentDiscount = discountCodes[code];
                msg.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle"></i> 優惠代碼有效！折抵 $${currentDiscount}</span>`;
                discountRow.style.display = 'flex';
                discountDisplay.innerText = `-$${currentDiscount}`;
                discountInput.value = currentDiscount;
            } else {
                currentDiscount = 0;
                msg.innerHTML = `<span class="text-red-500"><i class="fas fa-times-circle"></i> 無效的代碼</span>`;
                discountRow.style.display = 'none';
                discountInput.value = 0;
            }
            window.calculate();
        }

        function updateQuantityOptions(max) {
            const select = document.getElementById('quantitySelect');
            select.innerHTML = ''; 
            if (max <= 0) {
                const opt = document.createElement('option');
                opt.text = "已額滿";
                opt.value = 0;
                select.appendChild(opt);
                select.disabled = true;
            } else {
                select.disabled = false;
                for (let i = 1; i <= max; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = i;
                    select.appendChild(opt);
                }
            }
            const event = new Event('change');
            select.dispatchEvent(event);
        }

        function getRemainingCount(zoneId, dateStr) {
            // ★★★ 特殊邏輯：若是露營車且在加價日，剩餘數量為 0 (封鎖) ★★★
            const dynamicPrice = getDynamicPrice(zoneId, dateStr);
            if (dynamicPrice === -1) return 0;

            const defaultCount = zones.find(z => z.id === zoneId).count;
            let booked = 0;
            if (dateStr && bookedData[dateStr] && bookedData[dateStr][zoneId]) {
                booked = bookedData[dateStr][zoneId];
            }
            return Math.max(0, defaultCount - booked);
        }

        function setupCalculator() {
            const inDate = document.getElementById('checkinDate');
            const outDate = document.getElementById('checkoutDate');
            const bbqSelect = document.getElementById('bbqSelect');
            const resultDiv = document.getElementById('priceCalcResult');
            const validPriceResult = document.getElementById('validPriceResult');
            const blockedDateMsg = document.getElementById('blockedDateMsg');
            const formulaSpan = document.getElementById('priceFormula');
            const totalDisplay = document.getElementById('totalPriceDisplay');
            const subtotalDisplay = document.getElementById('subtotalDisplay');
            const stayDaysSpan = document.getElementById('stayDays');
            const submitBtn = document.getElementById('submitBtn');

            // 初始化：強制設定最小日期
            inDate.min = "2026-02-01";

            // 入住日期輸入監聽
            inDate.addEventListener('input', function() {
                const val = this.value;
                if (!val) {
                    cart = {}; // 重置
                    renderZones(currentFilter);
                    return;
                }
                
                // 僅設定退房日期的最小值
                const startDate = new Date(val);
                startDate.setDate(startDate.getDate() + 1);
                const yyyy = startDate.getFullYear();
                const mm = String(startDate.getMonth() + 1).padStart(2, '0');
                const dd = String(startDate.getDate()).padStart(2, '0');
                const minOutDate = `${yyyy}-${mm}-${dd}`;
                outDate.min = minOutDate;

                // 日期變動，檢查購物車庫存
                for(let id in cart) {
                    if (getRemainingCount(id, val) < cart[id]) {
                        cart[id] = 0; 
                    }
                }

                renderZones(currentFilter, val);
                calculate();
            });

            outDate.addEventListener('change', function() {
                calculate();
            });

            // 計算總價 (含區間檢查)
            function calculate() {
                const bbqQty = parseInt(bbqSelect.value) || 0;
                const bbqPrice = 1299;
                let days = 0;
                let stayPriceSum = {}; // 儲存每個區域的總房價

                // 重置錯誤訊息狀態
                blockedDateMsg.classList.add('hidden');
                validPriceResult.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                if (inDate.value && outDate.value) {
                    const start = new Date(inDate.value);
                    const end = new Date(outDate.value);
                    const diffTime = end - start;
                    days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (days <= 0) {
                        stayDaysSpan.classList.add('hidden');
                        days = 0;
                    } else {
                        stayDaysSpan.textContent = `共 ${days} 晚`;
                        stayDaysSpan.classList.remove('hidden');

                        // ★★★ 區間日期檢查逻辑 (關鍵修改) ★★★
                        // 初始化各區總價
                        for (let id in cart) stayPriceSum[id] = 0;

                        let tempDate = new Date(start);
                        let hasBlockedItem = false;
                        let foundClosedDate = null;

                        // 迴圈每一天
                        while(tempDate < end) {
                            const dStr = tempDate.toISOString().split('T')[0];
                            
                            // 1. 檢查是否整區封鎖 (closedDates)
                            if(closedDates.includes(dStr)) {
                                foundClosedDate = dStr;
                                break; // 只要有一天封鎖，整單無效
                            }

                            // 2. 計算價格
                            for(let id in cart) {
                                if(cart[id] > 0) {
                                    const p = getDynamicPrice(id, dStr);
                                    if (p === -1) {
                                        // 露營車等特定商品封鎖
                                        hasBlockedItem = true; 
                                    } else {
                                        stayPriceSum[id] += p;
                                    }
                                }
                            }
                            tempDate.setDate(tempDate.getDate() + 1);
                        }

                        // 如果發現封鎖日期，立即停止並顯示錯誤
                        if (foundClosedDate) {
                            resultDiv.classList.remove('hidden');
                            validPriceResult.classList.add('hidden');
                            blockedDateMsg.classList.remove('hidden');
                            blockedDateMsg.innerHTML = `
                                <div class="text-red-600 font-bold text-lg mb-2"><i class="fas fa-ban mr-2"></i>無法預訂</div>
                                <p class="text-gray-700">包含不開放預定日期：<br><span class="font-mono font-bold text-red-500">${foundClosedDate}</span></p>
                                <p class="text-xs text-gray-500 mt-2">請重新確認預定日期</p>
                            `;
                            // 鎖定送出按鈕
                            submitBtn.disabled = true;
                            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            return; // 結束計算
                        }
                    }
                } else {
                    stayDaysSpan.classList.add('hidden');
                }

                let roomTotal = 0;
                let totalTents = 0;
                for(let id in cart) {
                    if(cart[id] > 0) {
                        roomTotal += stayPriceSum[id] * cart[id];
                        totalTents += cart[id];
                    }
                }

                if (totalTents > 0 && days > 0) {
                    const bbqTotal = bbqPrice * bbqQty;
                    const subtotal = roomTotal + bbqTotal;
                    const finalTotal = Math.max(0, subtotal - currentDiscount);
                    
                    resultDiv.classList.remove('hidden');
                    subtotalDisplay.innerText = `$${subtotal.toLocaleString()}`;
                    
                    let formulaText = `${totalTents}帳 × ${days}晚 (自動計算平假日)`;
                    if (bbqQty > 0) formulaText += ` + 烤肉${bbqQty}份`;
                    if (currentDiscount > 0) formulaText += ` - 折扣$${currentDiscount}`;
                    
                    formulaSpan.textContent = formulaText;
                    totalDisplay.textContent = `$${finalTotal.toLocaleString()}`;
                } else {
                    resultDiv.classList.add('hidden');
                }
            }

            window.calculate = calculate;
            bbqSelect.addEventListener('change', calculate);
        }

        // 更新購物車
        window.updateCart = (zoneId, delta) => {
            const dateStr = document.getElementById('checkinDate').value;
            if(!dateStr) { alert("請先選擇入住日期！"); return; }

            const remaining = getRemainingCount(zoneId, dateStr);
            if (!cart[zoneId]) cart[zoneId] = 0;

            const newQty = cart[zoneId] + delta;
            
            if (newQty < 0) return; 
            if (newQty > remaining) { alert("已達該區剩餘上限！"); return; }

            cart[zoneId] = newQty;
            
            // 更新畫面數字
            const display = document.getElementById(`qty-display-${zoneId}`);
            if(display) display.textContent = newQty;
            
            // 更新卡片選中狀態
            renderZones(currentFilter, dateStr); 
            window.calculate();
        }

        function renderZones(filter, dateStr = null) {
            currentFilter = filter;
            if (!dateStr) dateStr = document.getElementById('checkinDate').value;

            const container = document.getElementById('zoneContainer');
            container.innerHTML = '';
            
            zones.forEach(zone => {
                if(filter !== 'all' && zone.cat !== filter) return;

                const remaining = getRemainingCount(zone.id, dateStr);
                const isSoldOut = remaining === 0;
                const currentQty = cart[zone.id] || 0;

                // ★★★ 取得當前日期的價格顯示 ★★★
                const displayPrice = (dateStr) ? getDynamicPrice(zone.id, dateStr) : zone.price;
                const priceText = (displayPrice === -1) ? '不開放' : `$${displayPrice.toLocaleString()}`;

                const div = document.createElement('div');
                div.className = `zone-card bg-white rounded-xl p-3 relative overflow-hidden flex items-center min-h-[9rem] h-auto ${isSoldOut ? 'sold-out' : ''}`;
                if (currentQty > 0) div.classList.add('selected');

                const badge = zone.badge ? `<span class="absolute top-0 right-0 bg-yellow-400 text-stone-900 text-xs font-bold px-2 py-1 rounded-bl-lg z-20 shadow-sm">${zone.badge}</span>` : '';
                
                const imgWrap = document.createElement('div');
                imgWrap.className = "w-32 h-full md:w-40 flex-shrink-0 rounded-lg overflow-hidden relative mr-4";
                const img = document.createElement('img');
                img.src = zone.images[zone.idx];
                img.className = "w-full h-full object-cover transition duration-500 hover:scale-110";
                
                if (zone.images.length > 1 && !isSoldOut) {
                    imgWrap.classList.add('cursor-change-image');
                    imgWrap.onclick = (e) => {
                        e.stopPropagation();
                        zone.idx = (zone.idx + 1) % zone.images.length;
                        img.src = zone.images[zone.idx];
                    }
                }
                imgWrap.prepend(img);

                const remainingText = isSoldOut 
                    ? `<span class="text-red-600 font-bold text-sm bg-red-100 px-2 py-0.5 rounded">已滿帳/不開放</span>` 
                    : `<span class="text-blue-600 text-sm font-bold bg-blue-50 px-2 py-0.5 rounded"><i class="fas fa-campground mr-1"></i>剩餘 ${remaining} 帳</span>`;

                const qtyControl = isSoldOut ? '' : `
                    <div class="flex items-center gap-3 mt-2">
                        <button type="button" class="qty-btn" onclick="updateCart('${zone.id}', -1)">-</button>
                        <span class="font-bold text-lg w-4 text-center" id="qty-display-${zone.id}">${currentQty}</span>
                        <button type="button" class="qty-btn" onclick="updateCart('${zone.id}', 1)">+</button>
                    </div>
                `;

                const info = document.createElement('div');
                info.className = "flex-1 flex flex-col justify-center";
                info.innerHTML = `
                    <h3 class="font-bold text-stone-800 text-lg leading-tight mb-1">${zone.name}</h3>
                    <p class="text-xs text-gray-500 font-medium mb-1">${zone.desc}</p>
                    <div class="mb-1">${remainingText}</div>
                    <div class="flex justify-between items-end">
                        <p class="text-green-600 font-bold text-lg">${priceText} <span class="text-xs text-gray-400 font-normal">/ 晚</span></p>
                        ${qtyControl}
                    </div>
                `;
                div.innerHTML = badge;
                div.appendChild(imgWrap);
                div.appendChild(info);
                container.appendChild(div);
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.onclick.toString().includes(`'${filter}'`)) {
                    btn.classList.add('active', 'text-white', 'bg-green-700');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('active', 'text-white', 'bg-green-700');
                    btn.classList.add('text-gray-500');
                }
            });
        }
        
        window.filterZones = (cat) => renderZones(cat);
        function renderGears() {
            const tbody = document.getElementById('gearTableBody');
            let html = '';
            gears.forEach(g => {
                html += `<tr class="border-b"><td class="px-4 py-2 text-stone-700">${g.n}</td><td class="px-4 py-2 text-right font-bold text-blue-600">$${g.p}</td></tr>`;
            });
            tbody.innerHTML = html;
        }
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if(sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full');
                ov.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full');
                ov.classList.add('hidden');
            }
        };
        window.showModal = (id) => {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('overlay').classList.remove('hidden');
            document.querySelectorAll('[id^="modal-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };
        window.closeAll = () => {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('overlay').classList.add('hidden');
            document.querySelectorAll('[id^="modal-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };
        window.adminLogin = () => {
            const pwd = prompt("請輸入營主密碼：");
            if (pwd === "Hank0219") {
                window.open(adminSheetURL, '_blank');
            } else if (pwd !== null) alert("密碼錯誤");
        };

        // 星星評分邏輯
        document.querySelectorAll('.rating-star').forEach(star => {
            star.addEventListener('click', function() {
                const val = this.dataset.val;
                document.getElementById('ratingInput').value = val;
                document.querySelectorAll('.rating-star').forEach(s => {
                    if (s.dataset.val <= val) s.classList.add('active');
                    else s.classList.remove('active');
                });
            });
        });

        // 回饋表單
        document.getElementById('feedbackForm').addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('feedbackBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = '處理中...';

            fetch(scriptURL, { 
                method: 'POST', 
                body: new FormData(e.target),
                mode: 'no-cors'
            })
            .then(() => {
                document.getElementById('feedback-form-container').classList.add('hidden');
                document.getElementById('feedback-success').classList.remove('hidden');
            })
            .catch(err => {
                alert('❌ 發生錯誤，請截圖聯繫營主！\n錯誤訊息: ' + err.message);
                btn.disabled = false;
                btn.innerText = originalText;
            });
        });

        // 訂位表單送出 (多選版 + 送出前二次檢查庫存)
        document.getElementById('bookingForm').addEventListener('submit', e => {
            e.preventDefault();

            // 新增：送出前最後檢查日期
            const inDateStr = document.getElementById('checkinDate').value;
            const outDateStr = document.getElementById('checkoutDate').value;
            
            if (inDateStr < "2026-02-01") {
                alert("入住日期必須在 2026年2月1日 之後！");
                return;
            }
            if (outDateStr <= inDateStr) {
                alert("退房日期必須晚於入住日期！");
                return;
            }
            
            // 1. 檢查是否有選購商品
            let totalQty = 0;
            let orderSummary = [];
            for(let id in cart) {
                if(cart[id] > 0) {
                    const zone = zones.find(z => z.id === id);
                    orderSummary.push(`${zone.name} x ${cart[id]}`);
                    totalQty += cart[id];
                }
            }

            if(totalQty === 0) { alert('請至少選擇一個營位！'); return; }

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = '正在檢查庫存...';

            // 送出前先 "再抓一次" 最新庫存
            fetch(scriptURL)
                .then(response => response.json())
                .then(latestData => {
                    // 更新本地庫存數據
                    bookedData = latestData;
                    
                    // 檢查購物車內的每一項，是否還有足夠庫存
                    let isStockEnough = true;
                    let errorMsg = "";

                    for(let id in cart) {
                        if(cart[id] > 0) {
                            const zone = zones.find(z => z.id === id);
                            const remaining = getRemainingCount(id, inDateStr);

                            if (cart[id] > remaining) {
                                isStockEnough = false;
                                errorMsg += `❌ ${zone.name} 只剩 ${remaining} 帳 (您預訂 ${cart[id]} 帳)\n`;
                                cart[id] = remaining; // 自動修正
                            }
                        }
                    }

                    if (!isStockEnough) {
                        alert(`⚠️ 很抱歉，剛剛有其他客人搶先預訂了，或者您選擇的日期不開放該營位！\n\n${errorMsg}\n系統已自動為您調整數量，請確認後再送出。`);
                        renderZones(currentFilter, inDateStr);
                        window.calculate(); 
                        btn.disabled = false;
                        btn.innerText = originalText;
                        return; // 中斷送出
                    }

                    // --- 庫存檢查通過，正式送出 ---
                    btn.innerText = '處理中...';
                    
                    const formData = new FormData(e.target);
                    formData.set('預訂區域', orderSummary.join(', '));
                    formData.set('預訂數量', totalQty); 

                    const bbqQty = parseInt(document.getElementById('bbqSelect').value) || 0;
                    
                    if(inDateStr && outDateStr) {
                        const start = new Date(inDateStr);
                        const end = new Date(outDateStr);
                        const diffTime = end - start;
                        const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        // ★★★ 使用逐日計算的總金額 ★★★
                        let roomTotal = 0;
                        let tempDate = new Date(start);
                        while(tempDate < end) {
                            const dStr = tempDate.toISOString().split('T')[0];
                            for(let id in cart) {
                                if(cart[id] > 0) {
                                    const p = getDynamicPrice(id, dStr);
                                    if(p > 0) roomTotal += p * cart[id];
                                }
                            }
                            tempDate.setDate(tempDate.getDate() + 1);
                        }

                        const subtotal = roomTotal + (1299 * bbqQty);
                        const total = Math.max(0, subtotal - currentDiscount);
                        
                        formData.append('入住天數', days);
                        formData.append('總金額', total);
                    }

                    return fetch(scriptURL, {
                        method: 'POST',
                        body: formData,
                        mode: 'no-cors'
                    });
                })
                .then(response => {
                    if(!response) return; // 被中斷的情況
                    alert('✅ 預訂送出成功！\n我們已收到您的資料，將盡快安排並聯繫您。');
                    e.target.reset();
                    cart = {};
                    document.getElementById('priceCalcResult').classList.add('hidden');
                    document.getElementById('stayDays').classList.add('hidden');
                    currentDiscount = 0;
                    document.getElementById('discountMsg').innerHTML = '';
                    document.getElementById('discountRow').style.display = 'none';
                    init(); // 重新載入庫存
                })
                .catch(err => {
                    alert('❌ 發生錯誤，請截圖聯繫營主！\n錯誤訊息: ' + err.message);
                    console.error(err);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerText = originalText;
                });
        });

        document.getElementById('paymentForm').addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('payBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = '傳送中...';

            fetch(scriptURL, { 
                method: 'POST', 
                body: new FormData(e.target),
                mode: 'no-cors'
            })
            .then(() => {
                alert('✅ 匯款回報成功！\n我們將盡快為您對帳。');
                e.target.reset();
                closeAll();
            })
            .catch(err => {
                alert('❌ 發生錯誤，請直接聯繫營主！\n錯誤訊息: ' + err.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = originalText;
            });
        });

        init();
    </script>
</body>
</html>